## Принцип работы сетевого чата

### Сервер(ServerApp)

1. Запускаем serverSocket и занимаем порт 8189
2. Ожидаем подключения на порту 8189 - serverSocket.accept(). Как только происходит подключение(serverSocket.accept() отпускает) в socket записывается информация о соединении с клиентом.
3. Когда открывается сетевое соединение, параллельно открывается два потока - две трубы данных, куда можно данные отправлять и откуда можно данные считывать:

       DataInputStream in = new DataInputStream(socket.getInputStream());
       DataOutputStream out = new DataOutputStream(socket.getOutputStream()); 

4. Запускаем бесконечный цикл и ждём сообщения от клиента:

       String inputMessage = in.readUTF();

    как только приходит сообщения от клиента мы складываем в строку inputMessage и печатаем в консоли

5. Отправляем клиенту его же сообщение с префиксом ECHO - это простейшая форма общения сервера и клиента - эхо сервер'

### Клиент(HelloController)

1. Есть многострочное текстовое поле, куда будут выводится сообщения чата:

        TextArea chatArea;

2. Однострочное текстовое поле, которое позволяет вводить сообщения и отправлять их на сервер

        TextField messageField;

3. Соединение с сервером 

         private Socket socket;

4. Входящие и исходящие потоки:

          private DataInputStream in;
          private DataOutputStream out;

5. Подключаемся к серверу:

        socket = new Socket("localhost", 8189);

6. Открываем два потока - на чтение и отправку сообщений:

       in = new DataInputStream(socket.getInputStream());
       out = new DataOutputStream(socket.getOutputStream());

7. Для чтения сообщений от сервера запускаем бесконечный цикл и ждём сообщения во входящем потоке - сидим и ждём когда что-то придёт от сервера. Как что-то приходит, кладём сообщение в строку:

       String inputMessage = in.readUTF();

и закидываем в поле нашего чата:

        chatArea.appendText(inputMessage + "\n");

ждём в цикле while(true) и печатаем сообщения от сервера

Почему вынесено в отдельный поток? Если бы цикл был запущен в методе initialize(), то мы бы не смогли даже показать окошко чата пользователю. Поэтому сделали отдельный поток для получения сообщений от сервера:

    Thread readThread = new Thread(() -> { 
      try {
         while(true) {
         String inputMessage = in.readUTF();
         chatArea.appendText(inputMessage + "\n");
         }
      } catch (IOException e) {
         e.printStackTrace();
         }
      });
      readThread.start();

8. Для отправки сообщений на сервер мы используем метод sendMessage(), который срабатывает когда мы жмём кнопку "Отправить" или если мы нажмём Enter на TextField. 
При отправке сообщений мы в исходящий поток:

       out.writeUTF(messageField.getText());

посылаем текстовое сообщение, которое написано на messageField. После ухода сообщения мы чистим поле messageField:

      messageField.clear();

и устанавливаем фокус(курсор) на messageField:

      messageField.requestFocus();

## Структура приложения
 
Server - основной модуль для работы  
ClientHandler - общение сервера с клиентом

В Server появился список клиентов. Когда клиент подключается, мы его запоминаем, создаём для него обработчик, отдаём ему ссылку на сервер и сокет соединения. Добавляем клиента в список клиентов. Есть метод рассылки всем клиентам какого-то сообщения - broadcastMessage(). вся логика общения с клиентом перетекает в ClientHandler. В ClientHandler мы запоминаем информацию о клиенте, запускаем поток. Если от клиента приходит сообщение, мы его запоминаем и рассылаем всем это сообщение. sendMessage() позволяет отправлять сообщение клиенту.



